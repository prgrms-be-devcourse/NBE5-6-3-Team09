<th:block th:fragment="alert-script">
  <style>
    @keyframes flash {
      0% { background-color: #ffffff; }
      100% { background-color: #ffeaa7; }
    }

    @keyframes blink-animation {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }

    .blink {
      animation: blink-animation 1s infinite;
    }

    /* âœ… í™”ë©´ ì „ì²´ ì ë©¸ íš¨ê³¼ */
    @keyframes screen-flash {
      0% { background-color: rgba(255, 234, 167, 0); }
      50% { background-color: rgba(255, 234, 167, 0.3); }
      100% { background-color: rgba(255, 234, 167, 0); }
    }

    .screen-flash {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      pointer-events: none !important;
      z-index: 2147483646 !important; /* íŒì—…ë³´ë‹¤ ì‚´ì§ ì•„ë˜ */
      animation: screen-flash 0.5s ease-in-out 3 !important;
    }

    /* âœ… íŒì—… ìŠ¤íƒ€ì¼ - z-index ë¬¸ì œ í•´ê²° */
    #notification-popup {
      display: none !important;
      position: fixed !important;
      top: 70px !important;
      right: 10px !important;
      background-color: #fff !important;
      border: 2px solid #007bff !important;
      border-radius: 12px !important;
      padding: 16px !important;
      box-shadow: 0px 12px 48px rgba(0,0,0,0.6) !important;
      width: 350px !important;
      max-height: 400px !important;
      overflow-y: auto !important;
      color: #333 !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;

      /* âœ… ê°€ì¥ ë†’ì€ ìš°ì„ ìˆœìœ„ë¡œ í‘œì‹œ */
      z-index: 2147483647 !important; /* 32ë¹„íŠ¸ ì •ìˆ˜ ìµœëŒ€ê°’ */

      /* âœ… ìƒˆë¡œìš´ stacking context ê°•ì œ ìƒì„± */
      isolation: isolate !important;

      /* âœ… GPU ê°€ì†ìœ¼ë¡œ ë³„ë„ ë ˆì´ì–´ ìƒì„± */
      transform: translateZ(0) !important;
    }

    #notification-popup.show {
      display: block !important;
      animation: popup-appear 0.2s ease-out !important;

      /* âœ… ì¶”ê°€ ë ˆì´ì–´ë§ ë³´ì¥ */
      will-change: transform, opacity !important;
      backface-visibility: hidden !important;
    }

    @keyframes popup-appear {
      0% {
        opacity: 0 !important;
        transform: scale(0.95) translateZ(0) !important;
      }
      100% {
        opacity: 1 !important;
        transform: scale(1) translateZ(0) !important;
      }
    }

    #notification-popup::before {
      content: '' !important;
      position: absolute !important;
      top: -10px !important;
      right: 30px !important;
      width: 0 !important;
      height: 0 !important;
      border-left: 10px solid transparent !important;
      border-right: 10px solid transparent !important;
      border-bottom: 10px solid #007bff !important;
    }

    #notification-popup p {
      margin: 0 !important;
      padding: 12px 0 !important;
      border-bottom: 1px solid #f0f0f0 !important;
      font-size: 14px !important;
      line-height: 1.5 !important;
    }

    #notification-popup p:last-child {
      border-bottom: none !important;
    }

    /* âœ… ì•Œë¦¼ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    #notification-icon {
      position: relative !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      display: inline-block !important;
      padding: 4px !important;
      z-index: 1000 !important;
      isolation: isolate !important; /* stacking context ìƒì„± */
    }

    #notification-icon:hover {
      transform: scale(1.1) !important;
    }

    #notification-icon:active {
      transform: scale(0.95) !important;
    }

    #notification-icon.blink {
      animation: blink-animation 0.8s ease-in-out infinite !important;
    }

    .notification-wrapper {
      position: relative !important;
      display: flex !important;
      align-items: center !important;
      min-width: 40px !important;
      min-height: 40px !important;
      justify-content: center !important;
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/

    // âœ… ì•Œë¦¼ìŒ ì¬ìƒ í•¨ìˆ˜
    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);

        console.log("ğŸ”Š ì•Œë¦¼ìŒ ì¬ìƒë¨");
      } catch (error) {
        console.log("ğŸ”‡ ì•Œë¦¼ìŒ ì¬ìƒ ì‹¤íŒ¨ (ê¶Œí•œ ì—†ìŒ):", error);
      }
    }

    // âœ… í™”ë©´ ì ë©¸ íš¨ê³¼
    function triggerScreenFlash() {
      const flashElement = document.createElement('div');
      flashElement.className = 'screen-flash';
      document.body.appendChild(flashElement);

      setTimeout(() => {
        if (flashElement.parentNode) {
          flashElement.parentNode.removeChild(flashElement);
        }
      }, 1500);

      console.log("âš¡ í™”ë©´ ì ë©¸ íš¨ê³¼ ì‹¤í–‰ë¨");
    }

    // âœ… íŒì—…ì„ bodyì— ì§ì ‘ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function ensurePopupInBody() {
      let popup = document.getElementById('notification-popup');

      if (!popup) {
        // íŒì—…ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        popup = document.createElement('div');
        popup.id = 'notification-popup';
        popup.innerHTML = '<p>ğŸ”• ì•„ì§ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }

      // í˜„ì¬ ë¶€ëª¨ê°€ bodyê°€ ì•„ë‹ˆë©´ bodyë¡œ ì´ë™
      if (popup.parentNode !== document.body) {
        // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }

        // bodyì— ì§ì ‘ ì¶”ê°€
        document.body.appendChild(popup);
        console.log("âœ… íŒì—…ì„ bodyë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.");
      }

      return popup;
    }

    // âœ… ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜ (ì¤‘ë³µ ë°©ì§€)
    window.initNotificationSystem = function() {
      console.log("ğŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...");

      const icon = document.getElementById('notification-icon');

      // ìš”ì†Œ ì¡´ì¬ í™•ì¸
      if (!icon) {
        console.error("âŒ notification-icon ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        console.log("ì‚¬ìš© ê°€ëŠ¥í•œ ìš”ì†Œë“¤:", document.querySelectorAll('[id*="notification"]'));
        return false;
      }

      console.log("âœ… ì•Œë¦¼ ì•„ì´ì½˜ í™•ì¸ë¨:", icon);

      // âœ… íŒì—…ì„ bodyì— í™•ì‹¤íˆ ìœ„ì¹˜ì‹œí‚¤ê¸°
      const popup = ensurePopupInBody();

      // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
      const newIcon = icon.cloneNode(true);
      icon.parentNode.replaceChild(newIcon, icon);

      // âœ… ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      newIcon.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        console.log("ğŸ”” ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­ë¨!");

        // íŒì—…ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³  bodyì— ìœ„ì¹˜ì‹œí‚¤ê¸°
        const popup = ensurePopupInBody();

        const isVisible = popup.classList.contains('show');

        if (isVisible) {
          // íŒì—… ìˆ¨ê¸°ê¸°
          popup.classList.remove('show');
          popup.style.display = 'none';
          console.log("íŒì—… ìˆ¨ê¹€");
        } else {
          // íŒì—… ë‚´ìš© í™•ì¸ ë° ì„¤ì •
          if (popup.innerHTML.trim() === '') {
            popup.innerHTML = '<p>ğŸ”• ì•„ì§ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          }

          // âœ… ìµœìƒìœ„ ë ˆì´ì–´ë¡œ ê°•ì œ ì´ë™
          popup.style.zIndex = '2147483647';
          popup.style.position = 'fixed';
          popup.style.isolation = 'isolate';

          // íŒì—… í‘œì‹œ
          popup.classList.add('show');
          popup.style.display = 'block';

          console.log("íŒì—… í‘œì‹œë¨:", popup.innerHTML);
        }
      });

      // âœ… íŒì—… ë°– í´ë¦­ ì‹œ íŒì—… ë‹«ê¸°
      document.addEventListener('click', function(e) {
        const popup = document.getElementById('notification-popup');
        const icon = document.getElementById('notification-icon');

        if (popup && popup.classList.contains('show') &&
            !popup.contains(e.target) && !icon.contains(e.target)) {
          popup.classList.remove('show');
          popup.style.display = 'none';
          console.log("íŒì—… ë°– í´ë¦­ìœ¼ë¡œ íŒì—… ë‹«í˜");
        }
      });

      // âœ… ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const popup = document.getElementById('notification-popup');

          if (popup && popup.classList.contains('show')) {
            popup.classList.remove('show');
            popup.style.display = 'none';
            console.log("ESC í‚¤ë¡œ íŒì—… ë‹«í˜");
          }
        }
      });

      // âœ… SSE ì—°ê²° (ê¸°ì¡´ ì—°ê²° ì •ë¦¬ í›„)
      if (window.notificationEventSource) {
        window.notificationEventSource.close();
        window.notificationEventSource = null;
      }

      try {
        const eventSource = new EventSource('/sse/alerts');
        window.notificationEventSource = eventSource;

        eventSource.addEventListener('ALERT', function(event) {
          try {
            console.log("ğŸ“© SSE ì•Œë¦¼ ìˆ˜ì‹ :", event.data);

            const todos = JSON.parse(event.data);
            if (!Array.isArray(todos) || todos.length === 0) return;

            const icon = document.getElementById('notification-icon');
            const popup = ensurePopupInBody(); // âœ… íŒì—… ìœ„ì¹˜ ì¬í™•ì¸

            if (icon && popup) {
              // âœ… ì‹œê°ì  íš¨ê³¼ë“¤ ì‹¤í–‰
              icon.classList.add('blink');
              setTimeout(() => icon.classList.remove('blink'), 5000);

              // í™”ë©´ ì ë©¸ íš¨ê³¼
              triggerScreenFlash();

              // ì•Œë¦¼ìŒ ì¬ìƒ
              playNotificationSound();

              // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
              popup.innerHTML = todos.map(todo => {
                const startTime = new Date(todo.startTime).toLocaleTimeString('ko-KR', {
                  hour: '2-digit',
                  minute: '2-digit'
                });
                return `<p>ğŸ• <strong>${todo.title}</strong><br/>
                        <span style="font-size: 12px; color: #666;">${startTime} ì‹œì‘ ì˜ˆì • (10ë¶„ ì „ ì•Œë¦¼)</span></p>`;
              }).join('');

              // âœ… ìµœìƒìœ„ í‘œì‹œ ê°•ì œ ì ìš©
              popup.style.zIndex = '2147483647';
              popup.style.position = 'fixed';
              popup.style.isolation = 'isolate';

              // íŒì—… ìë™ í‘œì‹œ
              popup.classList.add('show');
              popup.style.display = 'block';

              // 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
              setTimeout(() => {
                if (popup.classList.contains('show')) {
                  popup.classList.remove('show');
                  popup.style.display = 'none';
                }
              }, 10000);
            }
          } catch (error) {
            console.error("âŒ ì•Œë¦¼ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
          }
        });

        eventSource.addEventListener('CONNECTED', function() {
          console.log("âœ… SSE ì—°ê²° ì„±ê³µ");
        });

        eventSource.addEventListener('error', function(e) {
          console.error("âŒ SSE ì—°ê²° ì˜¤ë¥˜:", e);
        });

      } catch (error) {
        console.error("âŒ SSE ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
      }

      console.log("âœ… ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ");
      return true;
    };

    // âœ… ë‹¤ì–‘í•œ ì‹œì ì—ì„œ ì´ˆê¸°í™” ì‹œë„
    function tryInitNotification() {
      if (window.initNotificationSystem && window.initNotificationSystem()) {
        console.log("âœ… ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ");
        return;
      }

      // 0.5ì´ˆ í›„ ì¬ì‹œë„
      setTimeout(function() {
        if (window.initNotificationSystem) {
          window.initNotificationSystem();
        }
      }, 500);
    }

    // DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInitNotification);
    } else {
      tryInitNotification();
    }

    // í˜ì´ì§€ ì™„ì „ ë¡œë“œ í›„ì—ë„ í•œ ë²ˆ ë” ì‹œë„
    window.addEventListener('load', function() {
      setTimeout(tryInitNotification, 100);
    });

    // âœ… ì •ë¦¬ í•¨ìˆ˜
    window.addEventListener('beforeunload', function() {
      if (window.notificationEventSource) {
        window.notificationEventSource.close();
        window.notificationEventSource = null;
      }
    });

    /*]]>*/
  </script>
</th:block>