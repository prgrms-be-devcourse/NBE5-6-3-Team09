<div th:fragment="sidebar" class="sidebar">
  <nav class="sidebar-nav">
    <a th:href="@{/user/main}" class="nav-item" data-nav="main">
      <div class="nav-icon">ğŸ </div>
      <span class="nav-text">ë©”ì¸í™”ë©´</span>
      <div class="nav-indicator"></div>
    </a>

    <div class="nav-divider"></div>

    <a th:href="@{/todos/calender}" class="nav-item" data-nav="todos">
      <div class="nav-icon">âœ…</div>
      <span class="nav-text">íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸</span>
      <div class="nav-indicator"></div>
    </a>

    <a th:href="@{/routines}" class="nav-item" data-nav="routines">
      <div class="nav-icon">ğŸ¯</div>
      <span class="nav-text">ë°ì¼ë¦¬ ë£¨í‹´</span>
      <div class="nav-indicator"></div>
    </a>

    <a th:href="@{/jobposting/page}" class="nav-item" data-nav="jobposting">
      <div class="nav-icon">ğŸ’¼</div>
      <span class="nav-text">ì±„ìš©ê³µê³ </span>
      <div class="nav-indicator"></div>
    </a>

    <!-- ë©´ì ‘ ì§ˆë¬¸ (í´ë¦­ ë“œë¡­ë‹¤ìš´) -->
    <div class="nav-item-group" data-nav="interview">
      <div class="nav-item dropdown-toggle">
        <div class="nav-icon">ğŸ’¬</div>
        <span class="nav-text">ë©´ì ‘ ì§ˆë¬¸</span>
        <div class="dropdown-arrow">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 10l5 5 5-5H7z"/>
          </svg>
        </div>
        <div class="nav-indicator"></div>
      </div>
      <div class="dropdown-menu">
        <a th:href="@{/interview/select}" class="dropdown-item" data-path="/interview">
          <div class="dropdown-icon">ğŸ²</div>
          <span class="dropdown-text">ëœë¤ ë¬¸ì œí’€ì´</span>
        </a>
        <a th:href="@{/interview/history}" class="dropdown-item" data-path="/interview/history">
          <div class="dropdown-icon">ğŸ“</div>
          <span class="dropdown-text">ë‹µë³€ íˆìŠ¤í† ë¦¬</span>
        </a>
      </div>
    </div>

    <div class="nav-divider"></div>

    <a th:href="@{/mypage/stats}" class="nav-item" data-nav="stats">
      <div class="nav-icon">ğŸ“Š</div>
      <span class="nav-text">í•™ìŠµ í†µê³„</span>
      <div class="nav-indicator"></div>
    </a>

    <a th:href="@{/settings}" class="nav-item" data-nav="settings">
      <div class="nav-icon">âš™ï¸</div>
      <span class="nav-text">í™˜ê²½ì„¤ì •</span>
      <div class="nav-indicator"></div>
    </a>
  </nav>
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const currentPath = window.location.pathname;

      const pathMapping = {
        '/user/main': 'main',
        '/todos/calender': 'todos',
        '/todos': 'todos',
        '/routines': 'routines',
        '/jobposting/page': 'jobposting',
        '/interview/select': 'interview',
        '/interview/random': 'interview',
        '/interview/question': 'interview',
        '/interview/answer': 'interview',
        '/interview/history': 'interview',
        '/interview/result': 'interview',
        '/interview': 'interview',  // âœ… ê°€ì¥ í¬ê´„ì ì¸ fallback
        '/mypage/stats': 'stats',
        '/settings': 'settings'
      };

      // ê°€ì¥ ê¸´ ê²½ë¡œ ìš°ì„  ë§¤ì¹­
      const sortedPaths = Object.keys(pathMapping).sort((a, b) => b.length - a.length);
      let activeNav = null;
      for (const path of sortedPaths) {
        if (currentPath.startsWith(path)) {
          activeNav = pathMapping[path];
          break;
        }
      }

      if (activeNav) {
        // ë‹¨ì¼ ë©”ë‰´ ì²˜ë¦¬
        const activeItem = document.querySelector(`.sidebar .nav-item[data-nav="${activeNav}"]`);
        if (activeItem) {
          activeItem.classList.add('active');
        }

        // ë“œë¡­ë‹¤ìš´ ê·¸ë£¹ ì²˜ë¦¬
        const activeGroup = document.querySelector(`.sidebar .nav-item-group[data-nav="${activeNav}"]`);
        if (activeGroup) {
          activeGroup.classList.add('open');
          const toggle = activeGroup.querySelector('.dropdown-toggle');
          if (toggle) toggle.classList.add('active');
        }
      }

      // âœ… ë“œë¡­ë‹¤ìš´ ìì‹ í•­ëª© ìƒ‰ì¹ 
      const dropdownItems = document.querySelectorAll('.dropdown-item');
      dropdownItems.forEach(item => {
        const matchPath = item.dataset.path || item.getAttribute('href');
        if (!matchPath) return;

        // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, í•˜ìœ„ ê²½ë¡œì¸ ê²½ìš°
        const isExact = currentPath === matchPath;
        const isChild = currentPath.startsWith(matchPath + "/");

        // íŠ¹ë³„ ì²˜ë¦¬: "/interview" í•­ëª©ì€ "/interview/history"ì¼ ë•Œ ì œì™¸
        const isInterviewParent = matchPath === "/interview";
        const isHistoryPage = currentPath.startsWith("/interview/history");

        // ì¡°ê±´: ì¼ë°˜ ë§¤ì¹­ì´ê±°ë‚˜, ì¸í„°ë·° ë¶€ëª¨ë©´ì„œ íˆìŠ¤í† ë¦¬ ì•„ë‹Œ ê²½ìš°
        if ((isExact || isChild) && (!isInterviewParent || !isHistoryPage)) {
          item.classList.add('active');

          const parentGroup = item.closest('.nav-item-group');
          if (parentGroup) {
            parentGroup.classList.add('open');
            const parentToggle = parentGroup.querySelector('.dropdown-toggle');
            if (parentToggle) {
              parentToggle.classList.add('active');
            }
          }
        }
      });

      // âœ… í´ë¦­ ì• ë‹ˆë©”ì´ì…˜
      const navItems = document.querySelectorAll('.sidebar .nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function () {
          navItems.forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');
          const icon = this.querySelector('.nav-icon');
          if (icon) {
            icon.style.transform = 'scale(0.95)';
            setTimeout(() => {
              icon.style.transform = '';
            }, 150);
          }
        });

        item.addEventListener('mouseenter', function () {
          if (!this.classList.contains('active')) {
            this.style.transform = 'translateX(4px)';
          }
        });

        item.addEventListener('mouseleave', function () {
          if (!this.classList.contains('active')) {
            this.style.transform = '';
          }
        });
      });

      // âœ… ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í† ê¸€
      const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
      dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function (e) {
          e.stopPropagation();
          const parent = this.closest('.nav-item-group');
          parent.classList.toggle('open');

          // ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          document.querySelectorAll('.nav-item-group').forEach(group => {
            if (group !== parent) group.classList.remove('open');
          });
        });
      });

      // âœ… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', function (e) {
        document.querySelectorAll('.nav-item-group').forEach(group => {
          if (!group.contains(e.target)) {
            group.classList.remove('open');
          }
        });
      });

      // ì½˜ì†” ë””ë²„ê¹… (í•„ìš” ì‹œ ì œê±°)
      console.log('ğŸ“Œ currentPath:', currentPath);
      console.log('ğŸ“Œ activeNav:', activeNav);
    });
  </script>
</div>