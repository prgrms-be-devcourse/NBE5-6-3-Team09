<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>투두 리스트 조회</title>

  <!-- ✅ 공통 스타일 -->
  <link rel="stylesheet" th:href="@{/css/fragment/header.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/sidenav.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/chatbot.css}"/>

  <!-- ✅ 투두 리스트 전용 스타일 -->
  <link rel="stylesheet" th:href="@{/css/user/todo/todo-list.css}"/>
  <style>

  </style>
</head>

<body>
<!-- 배경 애니메이션 -->
<div class="background-animation">
  <div class="floating-shape"></div>
  <div class="floating-shape"></div>
  <div class="floating-shape"></div>
</div>

<!--알림 -->
<th:block th:replace="fragments/common/alert-script :: alert-script"></th:block>

<!-- ✅ 헤더 fragment 사용 -->
<header th:replace="fragments/header/header :: header"></header>

<!-- ✅ 사이드바 fragment 사용 -->
<aside th:replace="fragments/sidenav/user/user-sidenav :: sidebar"></aside>

<!-- 모달 컨테이너 -->
<div id="modalContainer"></div>

<main>
  <div class="main-container">

    <!-- ✅ 웰컴 섹션 -->
    <div class="welcome-section">
      <h1 class="welcome-title">📝 투두 리스트</h1>
      <p class="welcome-subtitle">📅 선택한 날짜: <span th:text="${selectedDate}"></span></p>
    </div>

    <!-- 📋 투두 리스트 섹션 -->
    <div class="content-section">
      <div class="section-header">
        <h3 class="section-title">📋 오늘의 할 일 목록</h3>
        <button class="add-btn" id="addTodoBtn" th:attr="data-date=${selectedDate}">
          + 새 할일 추가
        </button>
      </div>

      <!-- 투두가 있는 경우 -->
      <div th:if="${#lists.size(todos) > 0}" class="todo-table-wrapper">
        <div class="todo-table-container">
          <table class="todo-table">
            <thead>
            <tr>
              <th>📋 제목</th>
              <th>📝 내용</th>
              <th>⏰ 시간</th>
              <th>⚙️ 관리</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="todo : ${todos}"
                class="todo-row"
                th:classappend="${todo.completed} ? 'completed'">
              <td>
                <div class="todo-title">
                  <span th:text="${todo.title}">제목</span>
                  <span th:if="${todo.completed}" class="completed-badge">완료</span>
                </div>
              </td>
              <td>
                <div class="todo-description" th:text="${todo.description}">내용</div>
              </td>
              <td>
                <div class="todo-time">
                  <div class="time-item">
                    <span class="time-label">시작</span>
                    <span class="time-value" th:text="${#temporals.format(todo.startTime, 'HH:mm')}">10:00</span>
                  </div>
                  <div class="time-item">
                    <span class="time-label">마감</span>
                    <span class="time-value" th:text="${#temporals.format(todo.completedAt, 'MM-dd')}">06-17</span>
                  </div>
                </div>
              </td>
              <td class="menu-cell">
                <button class="menu-button">⋯
                  <div class="menu-box">
                    <div class="menu-item edit" th:attr="data-id=${todo.id}, data-date=${selectedDate}">
                      ✏️ 수정
                    </div>
                    <div class="menu-item delete" th:attr="data-id=${todo.id}, data-date=${selectedDate}">
                      🗑️ 삭제
                    </div>
                  </div>
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 빈 상태 표시 -->
      <div th:if="${#lists.size(todos) == 0}" class="empty-state">
        <div class="empty-state-icon">📝</div>
        <div class="empty-state-text">아직 등록된 할 일이 없습니다</div>
        <div class="empty-state-subtext">새로운 할 일을 추가해보세요!</div>
      </div>
    </div>

  </div> <!-- main-container end -->
</main>

<!-- 📱 챗봇 -->
<th:block th:replace="fragments/common/chatbot-modal :: chatbot"></th:block>

<script>
  // ✅ 저장된 테마 불러오기 (페이지 로드 시 최우선 실행)
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.classList.add(savedTheme + '-theme');

  // ✅ 페이지 로드 즉시 상단으로 스크롤 강제 실행
  document.addEventListener('DOMContentLoaded', function() {
    // 즉시 상단으로 스크롤
    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;

    // 추가 보장을 위해 약간의 지연 후 다시 실행
    setTimeout(() => {
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    }, 100);

    // 사이드바 투두리스트 메뉴 active 처리
    const todoButton = Array.from(document.querySelectorAll('.nav-link-button'))
    .find(el => el.textContent.includes('투두 리스트'));
    if (todoButton) todoButton.classList.add('active');

    // 투두 추가 버튼 이벤트
    document.getElementById('addTodoBtn').addEventListener('click', function () {
      const date = this.getAttribute('data-date');
      openAddModal(date);
    });

    // 메뉴 버튼 이벤트
    document.querySelectorAll('.menu-button').forEach(button => {
      button.addEventListener('click', function (event) {
        document.querySelectorAll('.menu-box').forEach(box => box.style.display = 'none');
        const menuBox = this.querySelector('.menu-box');
        if (menuBox) {
          menuBox.style.display = 'flex';
          event.stopPropagation();

          document.addEventListener('click', function handler(e) {
            if (!menuBox.contains(e.target) && e.target !== button) {
              menuBox.style.display = 'none';
              document.removeEventListener('click', handler);
            }
          });
        }
      });
    });

    // 수정 버튼 이벤트
    document.querySelectorAll('.menu-item.edit').forEach(btn => {
      btn.addEventListener('click', function () {
        openEditModal(this.getAttribute('data-id'), this.getAttribute('data-date'));
      });
    });

    // 삭제 버튼 이벤트
    document.querySelectorAll('.menu-item.delete').forEach(btn => {
      btn.addEventListener('click', function () {
        openDeleteModal(this.getAttribute('data-id'), this.getAttribute('data-date'));
      });
    });
  });

  // 모달 함수들
  window.openAddModal = function (date) {
    fetch(`/todos/new?date=${date}`)
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('modalContainer');
      container.innerHTML = html;
      container.style.display = 'block';
    });
  };

  window.openEditModal = function (id, date) {
    fetch(`/todos/${id}/edit?date=${date}`)
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('modalContainer');
      container.innerHTML = html;
      container.style.display = 'block';
    });
  };

  window.openDeleteModal = function (id, date) {
    fetch(`/todos/${id}/confirm-delete?date=${date}`)
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('modalContainer');
      container.innerHTML = html;
      container.style.display = 'block';
      document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        fetch(`/todos/${id}?date=${date}`, { method: "DELETE" }).then(res => {
          if (res.ok) window.location.href = `/todos?date=${date}`;
          else alert("삭제 실패");
        });
      });
    });
  };

  window.closeModal = function () {
    const container = document.getElementById('modalContainer');
    container.style.display = 'none';
    container.innerHTML = '';
  };

  // ✅ 브라우저 뒤로가기/앞으로가기 시에도 상단 스크롤 보장
  window.addEventListener('pageshow', function(event) {
    window.scrollTo(0, 0);
  });

  // ✅ 모든 로드 이벤트에서 스크롤 리셋
  window.addEventListener('load', function() {
    window.scrollTo(0, 0);
  });
</script>

</body>
</html>