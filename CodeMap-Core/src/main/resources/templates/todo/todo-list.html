<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ</title>

  <!-- âœ… ê³µí†µ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" th:href="@{/css/fragment/header.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/sidenav.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/chatbot.css}"/>

  <!-- âœ… íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" th:href="@{/css/user/todo/todo-list.css}"/>
  <style>

  </style>
</head>

<body>
<!-- ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ -->
<div class="background-animation">
  <div class="floating-shape"></div>
  <div class="floating-shape"></div>
  <div class="floating-shape"></div>
</div>

<!--ì•Œë¦¼ -->
<th:block th:replace="fragments/common/alert-script :: alert-script"></th:block>

<!-- âœ… í—¤ë” fragment ì‚¬ìš© -->
<header th:replace="fragments/header/header :: header"></header>

<!-- âœ… ì‚¬ì´ë“œë°” fragment ì‚¬ìš© -->
<aside th:replace="fragments/sidenav/user/user-sidenav :: sidebar"></aside>

<!-- ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ -->
<div id="modalContainer"></div>

<main>
  <div class="main-container">

    <!-- âœ… ì›°ì»´ ì„¹ì…˜ -->
    <div class="welcome-section">
      <h1 class="welcome-title">ğŸ“ íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸</h1>
      <p class="welcome-subtitle">ğŸ“… ì„ íƒí•œ ë‚ ì§œ: <span th:text="${selectedDate}"></span></p>
    </div>

    <!-- ğŸ“‹ íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
    <div class="content-section">
      <div class="section-header">
        <h3 class="section-title">ğŸ“‹ ì˜¤ëŠ˜ì˜ í•  ì¼ ëª©ë¡</h3>
        <button class="add-btn" id="addTodoBtn" th:attr="data-date=${selectedDate}">
          + ìƒˆ í• ì¼ ì¶”ê°€
        </button>
      </div>

      <!-- íˆ¬ë‘ê°€ ìˆëŠ” ê²½ìš° -->
      <div th:if="${#lists.size(todos) > 0}" class="todo-table-wrapper">
        <div class="todo-table-container">
          <table class="todo-table">
            <thead>
            <tr>
              <th>ğŸ“‹ ì œëª©</th>
              <th>ğŸ“ ë‚´ìš©</th>
              <th>â° ì‹œê°„</th>
              <th>âš™ï¸ ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="todo : ${todos}"
                class="todo-row"
                th:classappend="${todo.completed} ? 'completed'">
              <td>
                <div class="todo-title">
                  <span th:text="${todo.title}">ì œëª©</span>
                  <span th:if="${todo.completed}" class="completed-badge">ì™„ë£Œ</span>
                </div>
              </td>
              <td>
                <div class="todo-description" th:text="${todo.description}">ë‚´ìš©</div>
              </td>
              <td>
                <div class="todo-time">
                  <div class="time-item">
                    <span class="time-label">ì‹œì‘</span>
                    <span class="time-value" th:text="${#temporals.format(todo.startTime, 'HH:mm')}">10:00</span>
                  </div>
                  <div class="time-item">
                    <span class="time-label">ë§ˆê°</span>
                    <span class="time-value" th:text="${#temporals.format(todo.completedAt, 'MM-dd')}">06-17</span>
                  </div>
                </div>
              </td>
              <td class="menu-cell">
                <button class="menu-button">â‹¯
                  <div class="menu-box">
                    <div class="menu-item edit" th:attr="data-id=${todo.id}, data-date=${selectedDate}">
                      âœï¸ ìˆ˜ì •
                    </div>
                    <div class="menu-item delete" th:attr="data-id=${todo.id}, data-date=${selectedDate}">
                      ğŸ—‘ï¸ ì‚­ì œ
                    </div>
                  </div>
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ë¹ˆ ìƒíƒœ í‘œì‹œ -->
      <div th:if="${#lists.size(todos) == 0}" class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <div class="empty-state-text">ì•„ì§ ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-subtext">ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>
      </div>
    </div>

  </div> <!-- main-container end -->
</main>

<!-- ğŸ“± ì±—ë´‡ -->
<th:block th:replace="fragments/common/chatbot-modal :: chatbot"></th:block>

<script>
  // âœ… ì €ì¥ëœ í…Œë§ˆ ë¶ˆëŸ¬ì˜¤ê¸° (í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœìš°ì„  ì‹¤í–‰)
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.classList.add(savedTheme + '-theme');

  // âœ… í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ê°•ì œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', function() {
    // ì¦‰ì‹œ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;

    // ì¶”ê°€ ë³´ì¥ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ ì‹¤í–‰
    setTimeout(() => {
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    }, 100);

    // ì‚¬ì´ë“œë°” íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë©”ë‰´ active ì²˜ë¦¬
    const todoButton = Array.from(document.querySelectorAll('.nav-link-button'))
    .find(el => el.textContent.includes('íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸'));
    if (todoButton) todoButton.classList.add('active');

    // íˆ¬ë‘ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('addTodoBtn').addEventListener('click', function () {
      const date = this.getAttribute('data-date');
      openAddModal(date);
    });

    // ë©”ë‰´ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.menu-button').forEach(button => {
      button.addEventListener('click', function (event) {
        document.querySelectorAll('.menu-box').forEach(box => box.style.display = 'none');
        const menuBox = this.querySelector('.menu-box');
        if (menuBox) {
          menuBox.style.display = 'flex';
          event.stopPropagation();

          document.addEventListener('click', function handler(e) {
            if (!menuBox.contains(e.target) && e.target !== button) {
              menuBox.style.display = 'none';
              document.removeEventListener('click', handler);
            }
          });
        }
      });
    });

    // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.menu-item.edit').forEach(btn => {
      btn.addEventListener('click', function () {
        openEditModal(this.getAttribute('data-id'), this.getAttribute('data-date'));
      });
    });

    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.menu-item.delete').forEach(btn => {
      btn.addEventListener('click', function () {
        openDeleteModal(this.getAttribute('data-id'), this.getAttribute('data-date'));
      });
    });
  });

  // ëª¨ë‹¬ í•¨ìˆ˜ë“¤
  window.openAddModal = function (date) {
    fetch(`/todos/new?date=${date}`)
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('modalContainer');
      container.innerHTML = html;
      container.style.display = 'block';
    });
  };

  window.openEditModal = function (id, date) {
    fetch(`/todos/${id}/edit?date=${date}`)
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('modalContainer');
      container.innerHTML = html;
      container.style.display = 'block';
    });
  };

  window.openDeleteModal = function (id, date) {
    fetch(`/todos/${id}/confirm-delete?date=${date}`)
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('modalContainer');
      container.innerHTML = html;
      container.style.display = 'block';
      document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        fetch(`/todos/${id}?date=${date}`, { method: "DELETE" }).then(res => {
          if (res.ok) window.location.href = `/todos?date=${date}`;
          else alert("ì‚­ì œ ì‹¤íŒ¨");
        });
      });
    });
  };

  window.closeModal = function () {
    const container = document.getElementById('modalContainer');
    container.style.display = 'none';
    container.innerHTML = '';
  };

  // âœ… ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì‹œì—ë„ ìƒë‹¨ ìŠ¤í¬ë¡¤ ë³´ì¥
  window.addEventListener('pageshow', function(event) {
    window.scrollTo(0, 0);
  });

  // âœ… ëª¨ë“  ë¡œë“œ ì´ë²¤íŠ¸ì—ì„œ ìŠ¤í¬ë¡¤ ë¦¬ì…‹
  window.addEventListener('load', function() {
    window.scrollTo(0, 0);
  });
</script>

</body>
</html>