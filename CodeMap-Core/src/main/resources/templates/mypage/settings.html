<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>í™˜ê²½ ì„¤ì •</title>

  <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" th:href="@{/css/fragment/header.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/sidenav.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/chatbot.css}"/>

  <link rel="stylesheet" th:href="@{/css/user/settings.css}"/>
</head>

<body>
<!-- ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ -->
<div class="background-animation">
  <div class="floating-shape"></div>
  <div class="floating-shape"></div>
  <div class="floating-shape"></div>
</div>

<!--ì•Œë¦¼ -->
<th:block th:replace="fragments/common/alert-script :: alert-script"></th:block>

<!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
<div id="toast-container"></div>

<!-- CSRF í† í° (fallbackìš©) -->
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrf-token"/>

<header th:replace="fragments/header/header :: header"></header>
<aside th:replace="fragments/sidenav/user/user-sidenav :: sidebar"></aside>

<main>
  <div class="settings-container">

    <!-- ë‹‰ë„¤ì„ ìˆ˜ì • -->
    <div class="settings-card">
      <h2>ğŸ‘¤ ë‹‰ë„¤ì„ ìˆ˜ì •</h2>
      <div class="form-group">
        <label for="nickname">ìˆ˜ì •í•  ë‹‰ë„¤ì„</label>
        <input type="text" id="nickname" name="nickname" th:value="${user.nickname}" placeholder="ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required />
      </div>
      <button type="button" id="nickname-btn" class="submit-btn">
        <span class="btn-text">ë³€ê²½í•˜ê¸°</span>
        <span class="btn-loader" style="display: none;">ì²˜ë¦¬ì¤‘...</span>
      </button>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • -->
    <div class="settings-card">
      <h2>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
      <div class="form-group">
        <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input type="password" name="currentPassword" id="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required />
      </div>
      <div class="form-group">
        <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" name="newPassword" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required />
      </div>
      <button type="button" id="password-btn" class="submit-btn">
        <span class="btn-text">ë³€ê²½í•˜ê¸°</span>
        <span class="btn-loader" style="display: none;">ì²˜ë¦¬ì¤‘...</span>
      </button>
    </div>

    <!-- ì „ì²´ ì•Œë¦¼ ì„¤ì • -->
    <div class="settings-card">
      <h2>ğŸ”” ì•Œë¦¼ ì„¤ì •</h2>
      <label class="checkbox-label">
        <input type="checkbox" id="notificationEnabled" name="notificationEnabled" th:checked="${user.notificationEnabled}" />
        <span>ë°ì¼ë¦¬ ë£¨í‹´ & íˆ¬ë‘ ì•Œë¦¼ ë°›ê¸°</span>
      </label>
      <button type="button" id="notification-btn" class="submit-btn">
        <span class="btn-text">ì €ì¥í•˜ê¸°</span>
        <span class="btn-loader" style="display: none;">ì²˜ë¦¬ì¤‘...</span>
      </button>
    </div>

  </div>
</main>

<th:block th:replace="fragments/common/chatbot-modal :: chatbot"></th:block>

<script>
  document.addEventListener('DOMContentLoaded', function() {

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') ||
        document.querySelector('input[name="_csrf"]')?.value;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || '_csrf';

    // í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      toast.innerHTML = `
      <div class="toast-content">
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
      </div>
    `;

      const container = document.getElementById('toast-container');
      container.appendChild(toast);

      // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
      setTimeout(() => toast.classList.add('show'), 100);

      // ìë™ ì œê±°
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 300);
      }, 3000);
    }

    // ë²„íŠ¼ ë¡œë”© ìƒíƒœ ê´€ë¦¬
    function setButtonLoading(button, isLoading) {
      const btnText = button.querySelector('.btn-text');
      const btnLoader = button.querySelector('.btn-loader');

      if (isLoading) {
        button.disabled = true;
        button.classList.add('loading');
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline';
      } else {
        button.disabled = false;
        button.classList.remove('loading');
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
      }
    }

    // AJAX ìš”ì²­ í•¨ìˆ˜ (CSRF í† í° í¬í•¨)
    async function makeRequest(url, data) {
      const formData = new FormData();
      Object.keys(data).forEach(key => {
        formData.append(key, data[key]);
      });

      // CSRF í† í° ì¶”ê°€
      if (csrfToken) {
        formData.append('_csrf', csrfToken);
      }

      const headers = {};
      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      }

      const response = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: formData
      });

      return response;
    }

    // ë‹‰ë„¤ì„ ë³€ê²½
    document.getElementById('nickname-btn').addEventListener('click', async function() {
      const nickname = document.getElementById('nickname').value.trim();

      if (!nickname) {
        showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      setButtonLoading(this, true);

      try {
        const response = await makeRequest('/api/settings/nickname', { nickname });

        if (response.ok) {
          showToast('ë‹‰ë„¤ì„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

          // í—¤ë”ì˜ ë‹‰ë„¤ì„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
          updateHeaderNickname(nickname);

        } else {
          const errorText = await response.text();
          showToast(errorText || 'ë‹‰ë„¤ì„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        setButtonLoading(this, false);
      }
    });

    // í—¤ë” ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateHeaderNickname(newNickname) {
      // í—¤ë”ì˜ ì‚¬ìš©ì ì´ë¦„ ì—…ë°ì´íŠ¸
      const userNameElement = document.querySelector('.user-name');
      if (userNameElement) {
        userNameElement.textContent = newNickname;
      }

      // ì‚¬ìš©ì ì•„ë°”íƒ€ì˜ ì²« ê¸€ìë„ ì—…ë°ì´íŠ¸
      const userAvatarElement = document.querySelector('.user-avatar');
      if (userAvatarElement && newNickname) {
        userAvatarElement.textContent = newNickname.substring(0, 1).toUpperCase();
      }

      console.log(`í—¤ë” ë‹‰ë„¤ì„ì´ "${newNickname}"ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    document.getElementById('password-btn').addEventListener('click', async function() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;

      if (!currentPassword || !newPassword) {
        showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      if (newPassword.length < 4) {
        showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
        return;
      }

      setButtonLoading(this, true);

      try {
        const response = await makeRequest('/api/settings/password', {
          currentPassword,
          newPassword
        });

        if (response.ok) {
          showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
        } else {
          const errorText = await response.text();
          showToast(errorText || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        setButtonLoading(this, false);
      }
    });

    // ì•Œë¦¼ ì„¤ì • ë³€ê²½
    document.getElementById('notification-btn').addEventListener('click', async function() {
      const notificationEnabled = document.getElementById('notificationEnabled').checked;

      setButtonLoading(this, true);

      try {
        const response = await makeRequest('/api/settings/notification', {
          notificationEnabled
        });

        if (response.ok) {
          showToast('ì•Œë¦¼ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
          const errorText = await response.text();
          showToast(errorText || 'ì•Œë¦¼ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        setButtonLoading(this, false);
      }
    });

    // Enter í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.getElementById('nickname').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('nickname-btn').click();
      }
    });

    document.getElementById('newPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('password-btn').click();
      }
    });

  });
</script>

</body>
</html>